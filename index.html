<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ESP32 Relay Control</title>
<style>
  body { font-family: Arial, sans-serif; background: #f0f0f0; padding: 20px; }
  h1 { text-align: center; }
  .mode-toggle { margin: 20px auto; text-align: center; }
  .relays { max-width: 600px; margin: auto; }
  .relay {
    background: white; border-radius: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    margin: 10px 0; padding: 15px;
    display: flex; flex-direction: column;
  }
  .relay-header {
    display: flex; justify-content: space-between; align-items: center;
  }
  .relay-header label {
    font-weight: bold;
    font-size: 1.1rem;
  }
  button.toggle {
    padding: 8px 16px;
    font-size: 1rem;
    border: none; border-radius: 4px;
    cursor: pointer;
  }
  button.toggle.on { background: #4caf50; color: white; }
  button.toggle.off { background: #f44336; color: white; }
  .time-inputs {
    margin-top: 10px;
    display: flex; gap: 10px;
    align-items: center;
  }
  .time-inputs label {
    font-weight: normal;
  }
  input[type="time"] {
    padding: 5px;
    font-size: 1rem;
  }
</style>
</head>
<body>
<h1>ESP32 Relay Control</h1>

<div class="mode-toggle">
  <label>
    Mode:
    <select id="modeSelect">
      <option value="0">Manual</option>
      <option value="1">Auto</option>
    </select>
  </label>
</div>

<div class="relays" id="relaysContainer">
  <!-- Relays dynamically added here -->
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script>
  // Your Firebase config here (replace with your own)
  const firebaseConfig = {
    apiKey: "AIzaSyAFRKTkIcoocrSjdpNqdNCtElWDjX-AfBo",
    authDomain: "esp32livebutton-default-rtdb.firebaseapp.com",
    databaseURL: "https://esp32livebutton-default-rtdb.firebaseio.com",
    projectId: "esp32livebutton-default-rtdb",
    storageBucket: "esp32livebutton-default-rtdb.appspot.com",
    messagingSenderId: "your_sender_id",
    appId: "your_app_id"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const modeSelect = document.getElementById('modeSelect');
  const relaysContainer = document.getElementById('relaysContainer');

  // Create relay controls dynamically
  const relayCount = 7;
  let relayStates = [];
  let relayTimes = [];

  function createRelayUI(index) {
    const relayDiv = document.createElement('div');
    relayDiv.classList.add('relay');
    relayDiv.id = 'relay' + index;

    relayDiv.innerHTML = `
      <div class="relay-header">
        <label>Relay ${index}</label>
        <button class="toggle off" data-relay="${index}">OFF</button>
      </div>
      <div class="time-inputs" style="display:none;">
        <label>Start: <input type="time" id="startTime${index}"></label>
        <label>Stop: <input type="time" id="stopTime${index}"></label>
      </div>
    `;

    relaysContainer.appendChild(relayDiv);

    const toggleBtn = relayDiv.querySelector('button.toggle');
    toggleBtn.addEventListener('click', () => {
      const newState = toggleBtn.classList.contains('on') ? 0 : 1;
      setRelayState(index, newState);
    });

    // Time inputs listeners
    const startInput = relayDiv.querySelector(`#startTime${index}`);
    const stopInput = relayDiv.querySelector(`#stopTime${index}`);

    startInput.addEventListener('change', () => {
      setRelayTime(index, 'start', startInput.value);
    });
    stopInput.addEventListener('change', () => {
      setRelayTime(index, 'stop', stopInput.value);
    });
  }

  for(let i = 1; i <= relayCount; i++) {
    createRelayUI(i);
  }

  // Read and update mode from Firebase
  function listenMode() {
    db.ref('mode').on('value', (snapshot) => {
      const mode = snapshot.val();
      modeSelect.value = mode;
      updateUIByMode(mode);
    });
  }

  // Write mode change to Firebase
  modeSelect.addEventListener('change', () => {
    const newMode = parseInt(modeSelect.value);
    db.ref('mode').set(newMode);
    updateUIByMode(newMode);
  });

  // Enable/disable time inputs based on mode
  function updateUIByMode(mode) {
    for(let i = 1; i <= relayCount; i++) {
      const relayDiv = document.getElementById('relay' + i);
      const timeInputs = relayDiv.querySelector('.time-inputs');
      if(mode === 1) {
        timeInputs.style.display = 'flex';
      } else {
        timeInputs.style.display = 'none';
      }
    }
  }

  // Listen relay states & update UI
  function listenRelays() {
    for(let i=1; i <= relayCount; i++) {
      db.ref('relay' + i).on('value', (snapshot) => {
        const val = snapshot.val();
        updateRelayButton(i, val);
      });

      // Also listen times
      db.ref(`relayTimes/relay${i}`).on('value', (snapshot) => {
        const times = snapshot.val();
        if(times){
          const startInput = document.getElementById(`startTime${i}`);
          const stopInput = document.getElementById(`stopTime${i}`);
          startInput.value = times.start || "";
          stopInput.value = times.stop || "";
        }
      });
    }
  }

  function updateRelayButton(index, val) {
    const relayDiv = document.getElementById('relay' + index);
    const btn = relayDiv.querySelector('button.toggle');
    if(val == 1){
      btn.classList.remove('off');
      btn.classList.add('on');
      btn.textContent = "ON";
    } else {
      btn.classList.remove('on');
      btn.classList.add('off');
      btn.textContent = "OFF";
    }
  }

  function setRelayState(index, state) {
    db.ref('relay' + index).set(state);
  }

  function setRelayTime(index, type, timeStr) {
    const path = `relayTimes/relay${index}`;
    db.ref(path).update({ [type]: timeStr });
  }

  // Initialize listeners
  listenMode();
  listenRelays();
</script>
</body>
</html>
