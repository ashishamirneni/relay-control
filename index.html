<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ESP32 Relay Control</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #222;
    color: #eee;
    margin: 0; padding: 0;
    display: flex; flex-direction: column; align-items: center;
  }
  h1 {
    margin: 20px 0;
  }
  .mode-switch {
    margin-bottom: 20px;
  }
  .relay-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    width: 90vw;
    max-width: 900px;
  }
  .relay-card {
    background: #333;
    border-radius: 10px;
    padding: 15px;
  }
  .relay-card h2 {
    margin: 0 0 10px;
  }
  label {
    display: block;
    margin: 5px 0 3px;
  }
  input[type="checkbox"] {
    transform: scale(1.4);
    margin-right: 10px;
  }
  input[type="number"] {
    width: 60px;
    font-size: 1rem;
    padding: 5px;
    border-radius: 5px;
    border: none;
  }
  button {
    margin-top: 10px;
    padding: 10px;
    width: 100%;
    background: #06c;
    border: none;
    border-radius: 5px;
    color: white;
    font-weight: bold;
    cursor: pointer;
  }
  button:active {
    background: #0053a6;
  }
  #status {
    margin: 10px 0;
    font-weight: bold;
    color: #0f0;
  }
</style>
</head>
<body>

<h1>ESP32 Relay Control Panel</h1>

<div class="mode-switch">
  <label>
    <input type="checkbox" id="modeToggle" />
    Cloud Mode (On = cloud, Off = manual)
  </label>
</div>

<div id="status">Connecting...</div>

<div class="relay-container" id="relayContainer">
  <!-- Relay cards will be injected here -->
</div>

<script>
  const relayCount = 7;
  const relayContainer = document.getElementById('relayContainer');
  const modeToggle = document.getElementById('modeToggle');
  const statusEl = document.getElementById('status');

  // Initialize relay cards UI
  for (let i = 0; i < relayCount; i++) {
    const card = document.createElement('div');
    card.className = 'relay-card';
    card.id = `relayCard${i+1}`;
    card.innerHTML = `
      <h2>Relay ${i+1}</h2>
      <label><input type="checkbox" class="relaySwitch" data-relay="${i+1}" /> Relay ON/OFF</label>
      <fieldset>
        <legend>Schedule</legend>
        <label>Start Time:
          <input type="number" class="startHour" min="0" max="23" value="0" /> :
          <input type="number" class="startMinute" min="0" max="59" value="0" />
        </label>
        <label>Stop Time:
          <input type="number" class="stopHour" min="0" max="23" value="0" /> :
          <input type="number" class="stopMinute" min="0" max="59" value="0" />
        </label>
        <label><input type="checkbox" class="scheduleEnabled" /> Enable Schedule</label>
        <button class="saveScheduleBtn" data-relay="${i+1}">Save Schedule</button>
      </fieldset>
    `;
    relayContainer.appendChild(card);
  }

  // WebSocket or SSE connection could be used for real-time updates.
  // For simplicity, use periodic fetch every 5 seconds.
  async function fetchStatus() {
    try {
      const res = await fetch('/status');  // ESP32 should serve JSON data here
      if (!res.ok) throw new Error('Fetch failed');
      const data = await res.json();

      modeToggle.checked = data.mode === 1;
      statusEl.textContent = `Mode: ${modeToggle.checked ? 'Cloud' : 'Manual'}`;

      for (let i = 0; i < relayCount; i++) {
        const rNum = i + 1;
        const relayOn = data.relays[i] === 1;
        document.querySelector(`#relayCard${rNum} .relaySwitch`).checked = relayOn;

        const sched = data.schedules[i];
        document.querySelector(`#relayCard${rNum} .startHour`).value = sched.startHour;
        document.querySelector(`#relayCard${rNum} .startMinute`).value = sched.startMinute;
        document.querySelector(`#relayCard${rNum} .stopHour`).value = sched.stopHour;
        document.querySelector(`#relayCard${rNum} .stopMinute`).value = sched.stopMinute;
        document.querySelector(`#relayCard${rNum} .scheduleEnabled`).checked = sched.enabled;
      }
    } catch (e) {
      statusEl.textContent = 'Failed to connect';
      console.error(e);
    }
  }

  // Save relay state when toggled (only in cloud mode)
  relayContainer.addEventListener('change', async e => {
    if (!modeToggle.checked) return;  // only cloud mode

    if (e.target.classList.contains('relaySwitch')) {
      const relayNum = e.target.dataset.relay;
      const val = e.target.checked ? 1 : 0;
      try {
        await fetch(`/relay/${relayNum}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ state: val }),
        });
        statusEl.textContent = `Relay ${relayNum} state updated`;
      } catch {
        statusEl.textContent = `Failed to update Relay ${relayNum}`;
      }
    } else if (e.target.id === 'modeToggle') {
      const val = e.target.checked ? 1 : 0;
      try {
        await fetch(`/mode`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ mode: val }),
        });
        statusEl.textContent = `Mode set to ${val ? 'Cloud' : 'Manual'}`;
      } catch {
        statusEl.textContent = `Failed to update mode`;
      }
    }
  });

  // Save schedule button clicks
  relayContainer.addEventListener('click', async e => {
    if (e.target.classList.contains('saveScheduleBtn')) {
      const relayNum = e.target.dataset.relay;
      const card = document.querySelector(`#relayCard${relayNum}`);

      const startHour = parseInt(card.querySelector('.startHour').value);
      const startMinute = parseInt(card.querySelector('.startMinute').value);
      const stopHour = parseInt(card.querySelector('.stopHour').value);
      const stopMinute = parseInt(card.querySelector('.stopMinute').value);
      const enabled = card.querySelector('.scheduleEnabled').checked;

      try {
        await fetch(`/schedule/${relayNum}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ startHour, startMinute, stopHour, stopMinute, enabled }),
        });
        statusEl.textContent = `Schedule saved for Relay ${relayNum}`;
      } catch {
        statusEl.textContent = `Failed to save schedule for Relay ${relayNum}`;
      }
    }
  });

  // Initial fetch and periodic update
  fetchStatus();
  setInterval(fetchStatus, 5000);
</script>

</body>
</html>
