<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Relay Control</title>
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/babel-standalone@7.22.9/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js"></script>
</head>
<body class="bg-gray-100">
    <div id="root" class="container mx-auto p-4"></div>

    <script type="text/babel">
        const firebaseConfig = {
            apiKey: "AIzaSyAFRKTkIcoocrSjdpNqdNCtElWDjX-AfBo",
            databaseURL: "https://esp32livebutton-default-rtdb.firebaseio.com/",
        };
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        function RelayCard({ index }) {
            const [state, setState] = React.useState(false);
            const [schedule, setSchedule] = React.useState({
                startHour: 0,
                startMinute: 0,
                stopHour: 0,
                stopMinute: 0,
                enabled: false
            });

            React.useEffect(() => {
                const relayRef = db.ref(`relay${index + 1}`);
                const scheduleRef = db.ref(`schedule${index + 1}`);

                relayRef.on('value', (snapshot) => {
                    setState(snapshot.val() === 1);
                });

                scheduleRef.on('value', (snapshot) => {
                    setSchedule(snapshot.val() || {
                        startHour: 0,
                        startMinute: 0,
                        stopHour: 0,
                        stopMinute: 0,
                        enabled: false
                    });
                });

                return () => {
                    relayRef.off();
                    scheduleRef.off();
                };
            }, [index]);

            const toggleRelay = () => {
                db.ref(`relay${index + 1}`).set(state ? 0 : 1);
            };

            const updateSchedule = (field, value) => {
                const newSchedule = { ...schedule, [field]: parseInt(value) || 0 };
                setSchedule(newSchedule);
                db.ref(`schedule${index + 1}`).set(newSchedule);
            };

            const toggleSchedule = () => {
                const newSchedule = { ...schedule, enabled: !schedule.enabled };
                setSchedule(newSchedule);
                db.ref(`schedule${index + 1}`).set(newSchedule);
            };

            return (
                <div className="bg-white p-4 rounded-lg shadow-md mb-4">
                    <h2 className="text-lg font-semibold mb-2">Relay {index + 1}</h2>
                    <div className="flex items-center mb-4">
                        <span className="mr-2">State:</span>
                        <button
                            onClick={toggleRelay}
                            className={`px-4 py-2 rounded ${state ? 'bg-green-500' : 'bg-red-500'} text-white`}
                        >
                            {state ? 'ON' : 'OFF'}
                        </button>
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <label className="block text-sm">Start Time</label>
                            <input
                                type="number"
                                min="0"
                                max="23"
                                value={schedule.startHour}
                                onChange={(e) => updateSchedule('startHour', e.target.value)}
                                className="w-20 p-1 border rounded"
                                placeholder="Hour"
                            />
                            <input
                                type="number"
                                min="0"
                                max="59"
                                value={schedule.startMinute}
                                onChange={(e) => updateSchedule('startMinute', e.target.value)}
                                className="w-20 p-1 border rounded ml-2"
                                placeholder="Minute"
                            />
                        </div>
                        <div>
                            <label className="block text-sm">Stop Time</label>
                            <input
                                type="number"
                                min="0"
                                max="23"
                                value={schedule.stopHour}
                                onChange={(e) => updateSchedule('stopHour', e.target.value)}
                                className="w-20 p-1 border rounded"
                                placeholder="Hour"
                            />
                            <input
                                type="number"
                                min="0"
                                max="59"
                                value={schedule.stopMinute}
                                onChange={(e) => updateSchedule('stopMinute', e.target.value)}
                                className="w-20 p-1 border rounded ml-2"
                                placeholder="Minute"
                            />
                        </div>
                    </div>
                    <div className="mt-4">
                        <label className="flex items-center">
                            <input
                                type="checkbox"
                                checked={schedule.enabled}
                                onChange={toggleSchedule}
                                className="mr-2"
                            />
                            Enable Schedule
                        </label>
                    </div>
                </div>
            );
        }

        function App() {
            const [onlineStatus, setOnlineStatus] = React.useState(0);

            React.useEffect(() => {
                const statusRef = db.ref('onlineStatus');
                statusRef.on('value', (snapshot) => {
                    setOnlineStatus(snapshot.val());
                });
                return () => statusRef.off();
            }, []);

            return (
                <div className="max-w-2xl mx-auto">
                    <h1 className="text-2xl font-bold mb-4">ESP32 Relay Control</h1>
                    <div className="mb-4">
                        <span className="text-lg">
                            Status: {onlineStatus === 1 ? 
                                <span className="text-green-600">Online (Cloud Control)</span> : 
                                <span className="text-red-600">Offline (Local Control)</span>}
                        </span>
                    </div>
                    {[...Array(7)].map((_, index) => (
                        <RelayCard key={index} index={index} />
                    ))}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
